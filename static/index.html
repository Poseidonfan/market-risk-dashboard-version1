<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>QQQ / SPY çŸ­çº¿ç¯å¢ƒé£é™© & å¤šç©ºè¯„åˆ† Dashboardï¼ˆè‡ªåŠ¨æ•°æ®ï¼‰</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
      background: #020617;
      color: #e5e7eb;
    }

    body {
      margin: 0;
      padding: 24px;
      display: flex;
      flex-direction: column;
      gap: 20px;
      max-width: 1080px;
      box-sizing: border-box;
      margin-left: auto;
      margin-right: auto;
    }

    h1 {
      margin: 0 0 4px;
      font-size: 24px;
      font-weight: 700;
    }

    .sub {
      margin: 0 0 12px;
      font-size: 13px;
      color: #9ca3af;
    }

    .layout {
      display: grid;
      grid-template-columns: minmax(0, 2fr) minmax(0, 1.6fr);
      gap: 16px;
    }

    @media (max-width: 900px) {
      .layout {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .card {
      background: #020617;
      border-radius: 18px;
      padding: 16px 18px;
      border: 1px solid #1e293b;
      box-shadow: 0 16px 40px rgba(15, 23, 42, 0.8);
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 12px;
    }

    .card-title {
      font-size: 15px;
      font-weight: 600;
    }

    .badge {
      display: inline-flex;
      align-items: center;
      padding: 4px 8px;
      border-radius: 999px;
      font-size: 11px;
      font-weight: 600;
      letter-spacing: 0.03em;
      text-transform: uppercase;
      border: 1px solid #374151;
      color: #e5e7eb;
      background: #020617;
    }

    .overall-score {
      font-size: 32px;
      font-weight: 700;
    }

    .overall-tag {
      font-size: 13px;
      font-weight: 600;
      padding: 4px 10px;
      border-radius: 999px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .overall-tag span.dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      display: inline-block;
    }

    .bar {
      position: relative;
      width: 100%;
      height: 10px;
      border-radius: 999px;
      background: #020617;
      border: 1px solid #1f2937;
      overflow: hidden;
    }

    .bar-fill {
      height: 100%;
      border-radius: 999px;
      transition: width 0.4s ease;
    }

    .bar-label-row {
      display: flex;
      justify-content: space-between;
      font-size: 11px;
      color: #9ca3af;
      margin-top: 4px;
    }

    .small {
      font-size: 11px;
      color: #9ca3af;
    }

    .risk-flag {
      font-size: 12px;
      border-radius: 999px;
      padding: 4px 10px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      border: 1px solid #4b5563;
      background: #020617;
      color: #e5e7eb;
    }

    .risk-flag .dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      display: inline-block;
    }

    .score-row {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 12px;
    }

    .score-number {
      font-size: 20px;
      font-weight: 600;
    }

    .score-desc {
      font-size: 12px;
      color: #9ca3af;
      margin-top: 4px;
    }

    .pill {
      display: inline-flex;
      align-items: center;
      border-radius: 999px;
      padding: 2px 8px;
      font-size: 11px;
      border: 1px solid #374151;
      color: #9ca3af;
    }

    .footer {
      font-size: 11px;
      color: #6b7280;
      margin-top: 4px;
    }

    .error {
      color: #f97373;
      font-size: 12px;
      margin-top: 4px;
    }

    .btn {
      padding: 7px 12px;
      border-radius: 999px;
      border: 1px solid #4b5563;
      background: #111827;
      color: #e5e7eb;
      font-size: 12px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .btn:hover {
      background: #1f2937;
    }

    .btn[disabled] {
      opacity: 0.6;
      cursor: default;
    }

    a {
      color: #60a5fa;
      text-decoration: none;
    }
    a:hover {
      text-decoration: underline;
    }
  </style>
</head>
<body>
  <header>
    <h1>QQQ / SPY çŸ­çº¿ç¯å¢ƒé£é™© & å¤šç©ºè¯„åˆ† Dashboardï¼ˆè‡ªåŠ¨æ•°æ®ï¼‰</h1>
    <p class="sub">
      åç«¯è‡ªåŠ¨é€šè¿‡ yfinance + FRED è·å– Junk Bond Spreadã€Market Breadthã€ä»·æ ¼ç›¸å¯¹å‡çº¿ã€Put/Callã€VIXã€10Yâ€“2Y ç­‰ï¼Œ
      å¯¹å½“å‰ç¯å¢ƒç»™å‡ºä¸€ä¸ª 0â€“100 çš„å¤šç©ºè¯„åˆ†ï¼Œå¹¶æç¤ºé£é™©çŠ¶æ€ã€‚ä»…ä¸ºä¸ªäººç ”ç©¶ä½¿ç”¨ï¼Œä¸æ„æˆæŠ•èµ„å»ºè®®ã€‚
    </p>
  </header>

  <div class="layout">
    <!-- å·¦ä¾§ï¼šæ•´ä½“è¯„åˆ† + ä»·æ ¼è¶‹åŠ¿ -->
    <div class="stack">
      <section class="card" id="overall-card">
        <div class="card-header">
          <div class="card-title">ç»¼åˆçŸ­çº¿ç¯å¢ƒè¯„åˆ†ï¼ˆé’ˆå¯¹ QQQ / SPYï¼‰</div>
          <span class="badge" id="overall-badge">ç­‰å¾…æ•°æ®</span>
        </div>
        <div class="score-row">
          <div>
            <div class="overall-score" id="overall-score">--</div>
            <div class="overall-tag" id="overall-tag" style="background:#111827;">
              <span class="dot" id="overall-dot" style="background:#4b5563;"></span>
              <span id="overall-tag-text">å°šæœªè¯„ä¼°</span>
            </div>
          </div>
          <div>
            <div class="risk-flag" id="risk-flag">
              <span class="dot" id="risk-dot" style="background:#4b5563;"></span>
              <span id="risk-flag-text">é£é™©çŠ¶æ€ï¼šæœªçŸ¥</span>
            </div>
            <div class="small" id="confidence-text" style="margin-top:6px;">
              ç½®ä¿¡åº¦ï¼š--ï¼ˆæŒ‡æ ‡è¿‡å°‘æˆ–åˆ†æ­§å¾ˆå¤§æ—¶ï¼Œä¼šè‡ªåŠ¨æ”¶ç¼©è¯„åˆ†ï¼Œé¿å…è¢«å™ªéŸ³å¸¦åï¼‰
            </div>
          </div>
        </div>
        <div>
          <div class="bar">
            <div id="overall-bar" class="bar-fill" style="width:0%;background:linear-gradient(90deg,#f97373,#22c55e);"></div>
          </div>
          <div class="bar-label-row">
            <span>0 åç©º / é˜²å®ˆä¸ºä¸»</span>
            <span>50 éœ‡è¡ä¸­æ€§</span>
            <span>100 åå¤š / é¡ºåŠ¿åšå¤š</span>
          </div>
        </div>
        <div class="small" id="overall-comment">
          ç‚¹å‡»å³ä¸Šè§’â€œåˆ·æ–°æ•°æ®â€åï¼Œè¿™é‡Œä¼šå±•ç¤ºç»¼åˆè¯„åˆ†ä¸ç®€è¦è§£è¯»ã€‚
        </div>
      </section>

      <section class="card" id="price-card">
        <div class="card-header">
          <div class="card-title">ä»·æ ¼ & å‡çº¿è¶‹åŠ¿ï¼ˆSPY / QQQï¼‰</div>
          <span class="badge">è‡ªåŠ¨æ•°æ®ï¼ˆyfinanceï¼‰</span>
        </div>
        <div class="score-row">
          <div style="flex:1;">
            <div class="pill">SPY</div>
            <div class="score-desc" id="spy-desc">å°šæœªæ‹‰å–æ•°æ®</div>
          </div>
          <div style="flex:1;">
            <div class="pill">QQQ</div>
            <div class="score-desc" id="qqq-desc">å°šæœªæ‹‰å–æ•°æ®</div>
          </div>
        </div>
        <div class="score-row">
          <div>
            <div class="score-number" id="trend-score">--</div>
            <div class="score-desc">ä»·æ ¼è¶‹åŠ¿å­è¯„åˆ†ï¼ˆ0â€“100ï¼ŒSPY / QQQ ç»¼åˆï¼‰</div>
          </div>
          <div class="bar" style="max-width:260px;">
            <div id="trend-bar" class="bar-fill" style="width:0%;background:linear-gradient(90deg,#f97373,#22c55e);"></div>
          </div>
        </div>
        <div class="error" id="price-error"></div>
      </section>
    </div>

    <!-- å³ä¾§ï¼šå„å› å­å­è¯„åˆ† -->
    <div class="stack">
      <section class="card">
        <div class="card-header">
          <div class="card-title">å„å› å­å­è¯„åˆ†ï¼ˆ0â€“100ï¼‰</div>
          <button class="btn" id="refresh-btn">ğŸ”„ åˆ·æ–°æ•°æ®</button>
        </div>
        <div class="score-row">
          <div style="flex:1;">
            <div class="pill">Market Breadth</div>
            <div class="score-number" id="breadth-score">--</div>
            <div class="score-desc" id="breadth-comment">ç­‰å¾…æ•°æ®</div>
          </div>
          <div style="flex:1;">
            <div class="pill">Junk Bond Spread</div>
            <div class="score-number" id="junk-score">--</div>
            <div class="score-desc" id="junk-comment">ç­‰å¾…æ•°æ®</div>
          </div>
        </div>
        <div class="score-row">
          <div style="flex:1;">
            <div class="pill">Put/Call + VIX</div>
            <div class="score-number" id="sentiment-score">--</div>
            <div class="score-desc" id="sentiment-comment">ç­‰å¾…æ•°æ®</div>
          </div>
          <div style="flex:1;">
            <div class="pill">Yield Curveï¼ˆ10Yâ€“2Yï¼‰</div>
            <div class="score-number" id="yc-score">--</div>
            <div class="score-desc" id="yc-comment">ç­‰å¾…æ•°æ®</div>
          </div>
        </div>
        <div class="small" id="raw-values">
          åŸå§‹æŒ‡æ ‡ï¼šå°šæœªè·å–ã€‚
        </div>
      </section>
    </div>
  </div>

  <div class="footer">
    æç¤ºï¼šè¿™æ˜¯ä¸€ä¸ª<strong>ç¯å¢ƒ/æƒ…ç»ªä»ªè¡¨ç›˜</strong>ï¼Œåå‘ 1â€“10 ä¸ªäº¤æ˜“æ—¥çš„ç¯å¢ƒåˆ¤æ–­ï¼Œè€Œä¸æ˜¯é¢„æµ‹å•æ—¥æ¶¨è·Œã€‚
    æ•°æ®æ¥è‡ªå…è´¹å…¬å…±æºï¼ˆyfinance / FREDï¼‰ï¼Œå­˜åœ¨å»¶è¿Ÿä¸å¶å‘ç¼ºå¤±ï¼Œä»…ä¾›ä¸ªäººå‚è€ƒã€‚
  </div>

  <script>
    function clamp(v, lo, hi) {
      return Math.max(lo, Math.min(hi, v));
    }

    function updateBar(el, score) {
      if (score === null || score === undefined || isNaN(score)) {
        el.style.width = "0%";
        return;
      }
      el.style.width = clamp(score, 0, 100) + "%";
    }

    function fmtPct(x) {
      if (x === null || x === undefined || isNaN(x)) return "--";
      return x.toFixed(1) + "%";
    }

    function fmt(x, digits=2) {
      if (x === null || x === undefined || isNaN(x)) return "--";
      return x.toFixed(digits);
    }

    async function loadMetrics() {
      const btn = document.getElementById("refresh-btn");
      const priceErrEl = document.getElementById("price-error");
      btn.disabled = true;
      btn.textContent = "åŠ è½½ä¸­â€¦";
      priceErrEl.textContent = "";

      try {
        const res = await fetch("/metrics");
        if (!res.ok) throw new Error("HTTP " + res.status);
        const data = await res.json();

        const raw = data.raw || {};
        const scores = data.scores || {};
        const risk = data.risk_flag || {};
        const spy = raw.spy;
        const qqq = raw.qqq;

        const spyDescEl = document.getElementById("spy-desc");
        const qqqDescEl = document.getElementById("qqq-desc");

        function buildPriceDesc(m) {
          if (!m) return "æš‚æ— æ•°æ®ã€‚";
          const flags = [];
          if (m.price > m.ma50) flags.push("åœ¨ 50 æ—¥çº¿ä¸Šæ–¹");
          else flags.push("è·Œç ´ 50 æ—¥çº¿");
          if (m.price > m.ma100) flags.push("åœ¨ 100 æ—¥çº¿ä¸Šæ–¹");
          else flags.push("è·Œç ´ 100 æ—¥çº¿");
          if (m.price > m.ma200) flags.push("åœ¨ 200 æ—¥çº¿ä¸Šæ–¹");
          else flags.push("è·Œç ´ 200 æ—¥çº¿");

          const dev200 = (m.price - m.ma200) / m.ma200;
          let devTxt = "";
          if (Math.abs(dev200) < 0.03) devTxt = "è·ç¦» 200 æ—¥çº¿ä¸è¿œï¼Œå¤„ä¸­æ€§åŒºã€‚";
          else if (dev200 > 0) devTxt = "ç›¸å¯¹ 200 æ—¥çº¿åä¸Šï¼ˆä¹–ç¦»çº¦ " + (dev200*100).toFixed(1) + "%ï¼‰ã€‚";
          else devTxt = "ç›¸å¯¹ 200 æ—¥çº¿åä¸‹ï¼ˆä¹–ç¦»çº¦ " + (dev200*100).toFixed(1) + "%ï¼‰ã€‚";

          return (
            "ç°ä»· " + m.price.toFixed(2) +
            "ï¼Œ50/100/200 æ—¥çº¿çº¦ä¸º " +
            m.ma50.toFixed(2) + " / " +
            m.ma100.toFixed(2) + " / " +
            m.ma200.toFixed(2) +
            "ï¼›" + flags.join("ï¼Œ") + "ï¼›" + devTxt
          );
        }

        spyDescEl.textContent = buildPriceDesc(spy);
        qqqDescEl.textContent = buildPriceDesc(qqq);

        const trendScore = scores.trend;
        document.getElementById("trend-score").textContent =
          trendScore === null || trendScore === undefined ? "--" : trendScore.toFixed(0);
        updateBar(document.getElementById("trend-bar"), trendScore);
        if (!spy && !qqq) {
          priceErrEl.textContent = "SPY / QQQ æ•°æ®è·å–å¤±è´¥ï¼Œä»·æ ¼è¶‹åŠ¿è¯„åˆ†æš‚ä¸å¯ç”¨ã€‚";
        }

        const breadthScore = scores.breadth;
        const junkScore = scores.junk;
        const sentimentScore = scores.sentiment;
        const ycScore = scores.yc;

        const breadthCommentEl = document.getElementById("breadth-comment");
        const junkCommentEl = document.getElementById("junk-comment");
        const sentimentCommentEl = document.getElementById("sentiment-comment");
        const ycCommentEl = document.getElementById("yc-comment");

        const breadthPct = raw.breadth_pct;
        if (breadthScore === null || breadthScore === undefined) {
          document.getElementById("breadth-score").textContent = "--";
          breadthCommentEl.textContent = "æœªèƒ½è·å– Breadth æŒ‡æ ‡ï¼ˆä¾‹å¦‚ ^SPXA50Rï¼‰ï¼Œå¯èƒ½æ˜¯æ•°æ®æºæš‚ä¸å¯ç”¨ã€‚";
        } else {
          document.getElementById("breadth-score").textContent = breadthScore.toFixed(0);
          if (breadthPct < 30)
            breadthCommentEl.textContent = "å¤šæ•°æˆä»½è‚¡è·Œç ´ 50 æ—¥çº¿ï¼Œå†…éƒ¨å¹¿åº¦åå¼±ï¼Œç¯å¢ƒåç©ºä½†æœ‰åå¼¹æ½œåŠ›ã€‚";
          else if (breadthPct < 50)
            breadthCommentEl.textContent = "Breadth åå¼±ï¼ŒæŒ‡æ•°å¯èƒ½è¢«å°‘æ•°æƒé‡è‚¡æ”¯æ’‘ï¼ŒçŸ­çº¿ä¸å®œè¿‡åº¦ä¹è§‚ã€‚";
          else if (breadthPct < 80)
            breadthCommentEl.textContent = "å¤šæ•°æˆä»½è‚¡ç«™åœ¨ 50 æ—¥çº¿ä¹‹ä¸Šï¼Œå†…éƒ¨ç»“æ„å¥åº·ï¼Œåˆ©å¥½å¤šå¤´ã€‚";
          else if (breadthPct < 95)
            breadthCommentEl.textContent = "Breadth è¾ƒä¸ºæç«¯ï¼ŒçŸ­çº¿è™½å¼ºä½†å­˜åœ¨è·åˆ©å›åé£é™©ã€‚";
          else
            breadthCommentEl.textContent = "å‡ ä¹æ‰€æœ‰æˆä»½è‚¡éƒ½åœ¨ 50 æ—¥çº¿ä¹‹ä¸Šï¼Œæåº¦ä¸€è‡´ï¼Œéœ€è­¦æƒ•çŸ­çº¿åå‘æ³¢åŠ¨ã€‚";
        }

        if (junkScore === null || junkScore === undefined) {
          document.getElementById("junk-score").textContent = "--";
          junkCommentEl.textContent = "æœªèƒ½è·å– Junk Bond Spreadï¼ˆFRED / BAMLH0A0HYM2ï¼‰ï¼Œè¯·æ£€æŸ¥åç«¯ FRED_API_KEYã€‚";
        } else {
          document.getElementById("junk-score").textContent = junkScore.toFixed(0);
          const s = raw.junk_oas_bp;
          if (s < 250)
            junkCommentEl.textContent = "é«˜æ”¶ç›Šå€ºåˆ©å·®æåº¦ç´§å‡‘ï¼Œä¿¡ç”¨ç¯å¢ƒå¾ˆå¥½ä½†ä¹Ÿå¯èƒ½å­˜åœ¨â€œå¤ªä¹è§‚â€çš„éšå¿§ã€‚";
          else if (s < 350)
            junkCommentEl.textContent = "ä¿¡ç”¨åˆ©å·®æ•´ä½“åç´§ï¼Œè¯´æ˜é£é™©åå¥½å°šå¯ï¼Œå¯¹è‚¡å¸‚æ˜¯åŠ åˆ†ã€‚";
          else if (s < 500)
            junkCommentEl.textContent = "åˆ©å·®æ˜æ˜¾èµ°å®½ï¼Œä¿¡ç”¨å¼€å§‹æœ‰å‹åŠ›ï¼Œå¯¹é«˜è´å¡”èµ„äº§å½¢æˆæ£è‚˜ã€‚";
          else if (s < 800)
            junkCommentEl.textContent = "é«˜æ”¶ç›Šå€ºåˆ©å·®å·²ç»å¾ˆç´§å¼ ï¼Œé£é™©åå¥½æ˜¾è‘—ä¸‹é™ï¼Œéœ€è¦è­¦æƒ•ä¿¡ç”¨äº‹ä»¶ã€‚";
          else
            junkCommentEl.textContent = "æç«¯å®½çš„åˆ©å·®æ°´å¹³ï¼Œè¯´æ˜å¸‚åœºé«˜åº¦ç´§å¼ ï¼ŒåŠ¡å¿…æ§åˆ¶æ•´ä½“é£é™©æš´éœ²ã€‚";
        }

        if (sentimentScore === null || sentimentScore === undefined) {
          document.getElementById("sentiment-score").textContent = "--";
          sentimentCommentEl.textContent = "æœªèƒ½æœ‰æ•ˆè·å– Put/Call æˆ– VIXã€‚";
        } else {
          document.getElementById("sentiment-score").textContent = sentimentScore.toFixed(0);
          const putcall = raw.put_call;
          const vix = raw.vix;
          const parts = [];
          if (putcall !== null && putcall !== undefined && !isNaN(putcall)) {
            if (putcall < 0.6)
              parts.push("Put/Call å¾ˆä½ï¼Œæƒ…ç»ªåä¹è§‚ï¼ŒçŸ­çº¿å®¹æ˜“å‡ºç°åå‘æ³¢åŠ¨ã€‚");
            else if (putcall < 0.9)
              parts.push("Put/Call åæ­£å¸¸ç•¥åå¤šï¼Œæƒ…ç»ªä¸­æ€§åˆ°æ¸©å’Œä¹è§‚ã€‚");
            else if (putcall < 1.2)
              parts.push("Put/Call åé«˜ï¼Œè¯´æ˜é˜²å®ˆå•å¢å¤šï¼Œåè€Œåˆ©å¥½ä¸­æœŸå‘ä¸Šã€‚");
            else
              parts.push("Put/Call æé«˜ï¼Œææ…Œæƒ…ç»ªæ˜æ˜¾ï¼Œä½†ä¹Ÿå¯èƒ½å­•è‚²åå¼¹ã€‚");
          }
          if (vix !== null && vix !== undefined && !isNaN(vix)) {
            if (vix < 12)
              parts.push("VIX æä½ï¼Œå¸‚åœºéå¸¸å¹³é™ï¼Œéœ€é˜²æ­¢çªå‘æ³¢åŠ¨ã€‚");
            else if (vix < 20)
              parts.push("VIX åœ¨å¸¸è§„åŒºé—´ï¼Œæ³¢åŠ¨ç¯å¢ƒæ¸©å’Œã€‚");
            else if (vix < 30)
              parts.push("VIX ç•¥é«˜ï¼Œæ³¢åŠ¨æ”¾å¤§ï¼Œæ³¨æ„æ§åˆ¶ä»“ä½å’Œæ æ†ã€‚");
            else
              parts.push("VIX æ˜¾è‘—å‡é«˜ï¼Œå¸‚åœºé£é™©åå¥½ä¸‹é™ï¼Œè°¨æ…é˜²å®ˆä¼˜å…ˆã€‚");
          }
          sentimentCommentEl.textContent = parts.join(" ");
        }

        if (ycScore === null || ycScore === undefined) {
          document.getElementById("yc-score").textContent = "--";
          ycCommentEl.textContent = "æœªèƒ½è·å– 10Y / 2Y æ”¶ç›Šç‡ï¼Œæˆ–æ•°æ®ç¼ºå¤±ã€‚";
        } else {
          document.getElementById("yc-score").textContent = ycScore.toFixed(0);
          const yc = raw.yc_spread_bp;
          if (yc === null || yc === undefined || isNaN(yc)) {
            ycCommentEl.textContent = "æœªèƒ½è·å– 10Y / 2Y æ”¶ç›Šç‡ï¼Œæˆ–æ•°æ®ç¼ºå¤±ã€‚";
          } else if (yc > 100)
            ycCommentEl.textContent = "æ”¶ç›Šç‡æ›²çº¿é™¡å³­ä¸”ä¸ºæ­£ï¼Œå®è§‚ç¯å¢ƒåæ­£å¸¸ï¼Œå¯¹é£é™©èµ„äº§ä¸­æ€§ç•¥åå‹å¥½ã€‚";
          else if (yc > 0)
            ycCommentEl.textContent = "æ›²çº¿ç•¥å‘ˆæ­£æ–œç‡ï¼Œå°šç®—å¥åº·ã€‚";
          else if (yc > -50)
            ycCommentEl.textContent = "è½»å¾®å€’æŒ‚ï¼Œå®è§‚é¢„æœŸç•¥æœ‰æ‹…å¿§ï¼Œä½†å¯¹çŸ­çº¿èµ°åŠ¿å½±å“æœ‰é™ã€‚";
          else if (yc > -150)
            ycCommentEl.textContent = "æ›²çº¿æ˜¾è‘—å€’æŒ‚ï¼Œè¯´æ˜ä¸­é•¿æœŸç»æµæ‹…å¿§è¾ƒå¤§ï¼Œå¯¹æ•´ä½“ä¼°å€¼å½¢æˆçº¦æŸã€‚";
          else
            ycCommentEl.textContent = "æ·±åº¦å€’æŒ‚ï¼Œå¾€å¾€å¯¹åº”ç´§ç¼©åæœŸæˆ–ç»æµä¸‹è¡Œæ‹…å¿§ï¼Œéœ€é«˜åº¦é‡è§†ä¸­æœŸé£é™©ã€‚";
        }

        const overall = scores.overall;
        const std = scores.std;
        const count = scores.count;

        const overallScoreEl = document.getElementById("overall-score");
        const overallBadge = document.getElementById("overall-badge");
        const overallTag = document.getElementById("overall-tag");
        const overallDot = document.getElementById("overall-dot");
        const overallTagText = document.getElementById("overall-tag-text");
        const overallBar = document.getElementById("overall-bar");
        const overallComment = document.getElementById("overall-comment");
        const confText = document.getElementById("confidence-text");

        if (overall === null || overall === undefined || isNaN(overall)) {
          overallScoreEl.textContent = "--";
          overallBadge.textContent = "æ•°æ®ä¸è¶³";
          overallTagText.textContent = "å°šæœªè¯„ä¼°";
          updateBar(overallBar, null);
          overallComment.textContent = "è‡³å°‘éœ€è¦ä»·æ ¼è¶‹åŠ¿ + è‹¥å¹²å®è§‚/æƒ…ç»ªæŒ‡æ ‡ï¼Œæ‰æœ‰å‚è€ƒä»·å€¼ã€‚";
          confText.textContent = "ç½®ä¿¡åº¦ï¼š--";
        } else {
          overallScoreEl.textContent = overall.toFixed(0);
          updateBar(overallBar, overall);

          let tagColor = "#111827";
          let dotColor = "#4b5563";
          let tagTxt = "";

          if (overall >= 65) {
            tagColor = "#064e3b";
            dotColor = "#22c55e";
            tagTxt = "çŸ­çº¿åå¤šï¼šé¡ºåŠ¿åšå¤šä¸ºä¸»ï¼Œä½†æ³¨æ„è¿½é«˜é£é™©ã€‚";
            overallBadge.textContent = "ç¯å¢ƒåå¤š";
          } else if (overall >= 45) {
            tagColor = "#111827";
            dotColor = "#fbbf24";
            tagTxt = "éœ‡è¡ä¸­æ€§ï¼šå¤šç©ºåŠ›é‡æ¥è¿‘å¹³è¡¡ï¼Œä»¥ä»·ä½å’Œç»“æ„ä¸ºä¸»ã€‚";
            overallBadge.textContent = "éœ‡è¡åŒº";
          } else {
            tagColor = "#7f1d1d";
            dotColor = "#f97373";
            tagTxt = "çŸ­çº¿åç©ºï¼šé˜²å®ˆä¼˜å…ˆï¼Œé€¢é«˜å‡ä»“ / å¯¹å†²é£é™©ã€‚";
            overallBadge.textContent = "ç¯å¢ƒåç©º";
          }

          overallTag.style.background = tagColor;
          overallDot.style.background = dotColor;
          overallTagText.textContent = tagTxt;

          let confMsg;
          if (!count || count <= 2) {
            confMsg = "ç½®ä¿¡åº¦ï¼šè¾ƒä½ï¼ˆå‚ä¸åˆæˆçš„å› å­æ•°é‡è¾ƒå°‘ï¼Œå»ºè®®ä»…ä½œå‚è€ƒï¼‰ã€‚";
          } else if (std > 25) {
            confMsg = "ç½®ä¿¡åº¦ï¼šè¾ƒä½ï¼ˆå„å› å­åˆ†æ­§è¾ƒå¤§ï¼Œæ¨¡å‹å·²å¯¹æ€»åˆ†è¿›è¡Œæ”¶ç¼©å¤„ç†ï¼‰ã€‚";
          } else if (std > 15) {
            confMsg = "ç½®ä¿¡åº¦ï¼šä¸­ç­‰ï¼ˆéƒ¨åˆ†å› å­ä¹‹é—´æœ‰åˆ†æ­§ï¼Œå»ºè®®ç»“åˆä»·æ ¼å’ŒåŸºæœ¬é¢ä¸€èµ·çœ‹ï¼‰ã€‚";
          } else {
            confMsg = "ç½®ä¿¡åº¦ï¼šä¸­ç­‰åé«˜ï¼ˆä¸»è¦å› å­æ–¹å‘å¤§ä½“ä¸€è‡´ï¼Œä½†ä»éœ€é˜²èŒƒçªå‘æ•°æ®/æ¶ˆæ¯ï¼‰ã€‚";
          }
          confMsg += "ï¼ˆå‚ä¸å› å­æ•°é‡ï¼š" + count + "ï¼Œåˆ†æ­§æ ‡å‡†å·®çº¦ " + (std || 0).toFixed(1) + " åˆ†ï¼‰";
          confText.textContent = confMsg;

          overallComment.textContent =
            "ç»¼åˆè€ƒè™‘ä»·æ ¼è¶‹åŠ¿ã€å†…éƒ¨å¹¿åº¦ã€ä¿¡ç”¨åˆ©å·®ã€æƒ…ç»ªï¼ˆPut/Call + VIXï¼‰ä»¥åŠæ”¶ç›Šç‡æ›²çº¿ï¼Œå½“å‰ç¯å¢ƒç»™å‡ºçš„å¤šç©ºè¯„åˆ†ä¸º " +
            overall.toFixed(0) + " åˆ†ã€‚è¯·ç»“åˆä½ è‡ªå·±çš„æŒä»“ç»“æ„å’Œé£é™©æ‰¿å—èƒ½åŠ›ä½¿ç”¨ã€‚";
        }

        const riskFlag = document.getElementById("risk-flag");
        const riskDot = document.getElementById("risk-dot");
        const riskText = document.getElementById("risk-flag-text");
        if (risk && risk.text) {
          riskText.textContent = risk.text;
        }
        if (risk && risk.color) {
          riskFlag.style.borderColor = risk.color;
          riskDot.style.background = risk.color;
        }

        const rawEl = document.getElementById("raw-values");
        const parts = [];
        if (raw.breadth_pct !== null && raw.breadth_pct !== undefined)
          parts.push("Breadthï¼ˆ^SPXA50Rï¼‰ï¼šçº¦ " + fmt(raw.breadth_pct, 1) + "%");
        if (raw.junk_oas_bp !== null && raw.junk_oas_bp !== undefined)
          parts.push("Junk OASï¼ˆBAMLH0A0HYM2ï¼‰ï¼šçº¦ " + fmt(raw.junk_oas_bp, 0) + " bp");
        if (raw.put_call !== null && raw.put_call !== undefined)
          parts.push("Put/Callï¼ˆ^CPCï¼‰ï¼šçº¦ " + fmt(raw.put_call, 2));
        if (raw.vix !== null && raw.vix !== undefined)
          parts.push("VIXï¼ˆ^VIXï¼‰ï¼šçº¦ " + fmt(raw.vix, 2));
        if (raw.y10 !== null && raw.y10 !== undefined && raw.y2 !== null && raw.y2 !== undefined)
          parts.push("10Y â‰ˆ " + fmt(raw.y10, 2) + "%ï¼Œ2Y â‰ˆ " + fmt(raw.y2, 2) + "%ï¼Œ10Yâ€“2Y â‰ˆ " + fmt(raw.yc_spread_bp, 0) + " bp");

        rawEl.textContent =
          parts.length ? ("åŸå§‹æŒ‡æ ‡ï¼š" + parts.join("ï¼›")) : "åŸå§‹æŒ‡æ ‡ï¼šéƒ¨åˆ†æ•°æ®æœªè·å–æˆåŠŸã€‚";

      } catch (e) {
        console.error(e);
        document.getElementById("overall-badge").textContent = "è¯·æ±‚å¤±è´¥";
        document.getElementById("overall-comment").textContent =
          "è°ƒç”¨ /metrics æ¥å£å¤±è´¥ï¼Œå¯èƒ½æ˜¯åç«¯æœªæ­£ç¡®éƒ¨ç½²æˆ–æš‚æ—¶ä¸å¯ç”¨ã€‚";
        document.getElementById("price-error").textContent =
          "æ— æ³•ä»åç«¯è·å– SPY / QQQ / å®è§‚æŒ‡æ ‡ï¼Œè¯·æ£€æŸ¥æœåŠ¡æ˜¯å¦è¿è¡Œæ­£å¸¸ã€‚";
      } finally {
        btn.disabled = false;
        btn.textContent = "ğŸ”„ åˆ·æ–°æ•°æ®";
      }
    }

    document.getElementById("refresh-btn").addEventListener("click", loadMetrics);
    loadMetrics();
  </script>
</body>
</html>
